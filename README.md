# Утилита развертывания и бэкапа SunlineSCADA

## Прежде чем начать

Данная инструкция подразумевает использование готового образа утилиты, доступного в реестре registry.nashascada.site, а значит не требует скачивания исходников или стороннего софта, кроме Docker и docker-compose, но требует аутентификации в этом реестре.

Все команды необходимо выполнять из папки приложения, либо новой папки в случае развертывания нового приложения.


## Справка по переменным среды

* **DB_HOST** - адрес сервера базы данных.
* **DB_DATABASE** - имя базы данных. (будет создана в процессе инициализации)
* **DB_USER** - имя пользователя базы данных. (будет создан в процессе инициализации)
* **DB_PASSWORD** - пароль пользователя базы данных. (будет создан в процессе инициализации)

Переменные среды, необходимые только для развертывания нового приложения или удаления:

* **DB_ROOT_USER** - имя пользователя базы данных с правами на создание баз данных и добавление пользователей.
* **DB_ROOT_PASSWORD** - пароль пользователя базы данных с правами на создание баз данных и добавление пользователей.
* **SCADA_URL** - URL по которому планируется расположить веб-интерфейс. Используется для заполнения конфигурационного файла. Опционально.

Для удобства, а так же чтобы пароли не попадали в историю автодополнения, лучше создать файл с переменными среды .env и поместить в него необходимые данные, в дальнейшем подразумевается что он уже создан:

```bash
DB_HOST=example.com
DB_DATABASE=demo
DB_USER=demo
DB_PASSWORD=demo
# Необходимы только для развертывания или удаления
DB_ROOT_USER=root
DB_ROOT_PASSWORD=root
# Необходимо только для развертывания, опционально
SCADA_URL=https://example.com
```


## Развертывание нового приложения

В результате работы утилиты создается новая база данных с указанным пользователем, имеющим полный доступ только к этой базе, создаются конфигурационные файлы необходимые для работы приложения и docker-compose, а также папка с данными.

Для развертывания из снапшота по умолчанию, идущего в образе:

```bash
docker run --rm --env-file .env -v ${PWD}:/scada registry.nashascada.site/scada-cli create
```

Для развертывания из произвольного снапшота, при условии что он находится в текущей или вложенной папке:

```bash
docker run --rm --env-file .env -v ${PWD}:/scada registry.nashascada.site/scada-cli create файл_снапшота
```

Дальше приложение можно запустить с помощью docker-compose:

```bash
docker-compose up -d
```

Для того чтобы настроить порт на отличный от 80 или добавить контейнеры в конкретную сеть, необходимо отредактировать файл docker-compose.yml


## Создание снапшота

Для создания файла снапшота в текущей или вложенной папке:

```bash
docker run --rm --env-file .env -v ${PWD}:/scada registry.nashascada.site/scada-cli backup файл_снапшота
```

Внимание - создание дампа базы данных может занять много времени, при этом нет возможности отобразить прогресс этой операции.


## Откат существующего приложения

⚠ Опасная операция, подтверждение не выводится, не выполнять без бэкапа ⚠

Предварительно необходимо остановить контейнеры:

```bash
docker-compose stop
```

Для сброса на снапшот по умолчанию, идущий в образе:

```bash
docker run --rm --env-file .env -v ${PWD}:/scada registry.nashascada.site/scada-cli restore
```

Для сброса на произвольный снапшот, при условии что он находится в текущей или вложенной папке:

```bash
docker run --rm --env-file .env -v ${PWD}:/scada registry.nashascada.site/scada-cli restore файл_снапшота
```

Снова запустить контейнеры:

```bash
docker-compose start
```


## Удаление приложения

⚠ Опасная операция, подтверждение не выводится, не выполнять без бэкапа ⚠

Команда удаления очищает базу данных и текущую папку от изменений сделанных командой установки.

Предварительно необходимо остановить и удалить контейнеры:

```bash
docker-compose down
```

Для удаления выполнить команду:

```bash
docker run --rm --env-file .env -v ${PWD}:/scada registry.nashascada.site/scada-cli remove
```


## Обновление образа утилиты

Для обновления утилиты до последней версии:

```bash
docker pull registry.nashascada.site/scada-cli
```


## Сборка Docker-образа

Образ собирается стандартым для Docker способом:

```bash
docker build -t имя_образа .
```